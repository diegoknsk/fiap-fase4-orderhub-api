name: PR - Build, Test, Sonar

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache Sonar
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Sonar - Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          dotnet-sonarscanner begin
          /k:"diegoknsk_fiap-fase4-orderhub-api"
          /o:"diegoknsk"
          /d:sonar.token="$SONAR_TOKEN"
          /d:sonar.cs.opencover.reportsPaths="**/TestResults/coverage/coverage.opencover.xml"
          /d:sonar.coverage.exclusions="**/*Program.cs,**/*Startup.cs,**/Migrations/**,**/*Dto.cs"
          /d:sonar.scanner.scanAll=false
          /d:sonar.projectBaseDir="${{ github.workspace }}"

      - name: Restore
        run: dotnet restore FastFood.OrderHub.sln

      - name: Build
        run: dotnet build FastFood.OrderHub.sln -c Release --no-restore /p:DebugType=portable /p:DebugSymbols=true

      - name: Test (Unit + BDD) with coverage
        run: >
          dotnet test FastFood.OrderHub.sln -c Release --no-build
          --logger "trx;LogFileName=test_results.trx"
          /p:CollectCoverage=true
          /p:CoverletOutputFormat="opencover"
          /p:CoverletOutput="./TestResults/coverage/"

      - name: List coverage files
        run: |
          echo "=== Coverage files generated ==="
          find . -name "coverage.opencover.xml" -type f || echo "No coverage files found"
          echo ""
          echo "=== TestResults directory structure ==="
          ls -la TestResults/ || echo "TestResults directory not found"
          echo ""
          echo "=== TestResults/coverage directory structure ==="
          ls -la TestResults/coverage/ || echo "TestResults/coverage directory not found"

      - name: Consolidate coverage reports
        run: |
          mkdir -p ./TestResults/coverage
          # Find all coverage files and copy the first one (or merge if needed)
          COVERAGE_FILES=$(find . -path "*/TestResults/*/coverage.opencover.xml" -type f)
          if [ -n "$COVERAGE_FILES" ]; then
            # If multiple files, we'll use the first one for now
            # In a real scenario, you might want to merge them
            FIRST_FILE=$(echo "$COVERAGE_FILES" | head -n 1)
            cp "$FIRST_FILE" ./TestResults/coverage/coverage.opencover.xml
            echo "=== Coverage file consolidated ==="
            ls -la ./TestResults/coverage/
          else
            echo "No coverage files found to consolidate"
          fi

      - name: Verify coverage file before Sonar End
        run: |
          echo "=== Verifying coverage file ==="
          if [ -f "./TestResults/coverage/coverage.opencover.xml" ]; then
            echo "✓ Coverage file exists at ./TestResults/coverage/coverage.opencover.xml"
            ls -lh ./TestResults/coverage/coverage.opencover.xml
            echo "File size: $(du -h ./TestResults/coverage/coverage.opencover.xml | cut -f1)"
          else
            echo "✗ Coverage file NOT found at ./TestResults/coverage/coverage.opencover.xml"
            echo "Searching for coverage files..."
            find . -name "coverage.opencover.xml" -type f
            exit 1
          fi

      - name: Sonar - End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.token="$SONAR_TOKEN"
